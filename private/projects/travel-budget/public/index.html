<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Travel Expenses</title>
    <link rel="icon" href="img/favicon-onedrive.ico" type="image/x-icon">
    <link rel="shortcut icon" href="img/favicon-onedrive.ico" type="image/x-icon">

    <link rel="stylesheet" href="chart-style.css" type="text/css">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="chart-styles.js" type="text/javascript"></script>
    <script src="d3helper.js" type="text/javascript"></script>
    <script src="render-daily-area-chart.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>
    <!--
    <script src="https://ajax.googleapis.com/ajax/libs/prototype/1.7.2.0/prototype.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.10/webfont.js"></script>
    <script src="js/vendor/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="js/vendor/d3.v2.min.js" type="text/javascript"></script>
    <script src="js/vendor/jquery-ui-1.8.23.custom.min.js" type="text/javascript"></script>
     -->
    <style type="text/css">
html {
    font-family: Segoe UI Light, "Helvetica Neue", "Open Sans Light", Verdana, Sans-Serif;
}

h1 {
    display:inline;
    margin-top: 0.1em;
    margin-bottom: 0.1em;
    margin-left: 0.5em;
    float: left;
    font-weight: 200;
}

.instructions {
    color: #777;
    margin-left: 1.5em;
    float: left;
    font-size: 0.9em;
}

.top-bar-shade {
    color: blue;
    fill: #ddf;
}

.header-controls {
    margin-top: 0.1em;
    margin-bottom: 0.1em;
    margin-left: 0.5em;
    display:inline;
    float:right;
}

select {
    font-size: 8.0em;
}


    </style>
    <script type='text/javascript'>

$.GLOBALS = { };
    
function cost(row) {
    "use strict";
    
    var exchange_rates = {
        'CAD' : 0.8,
        'KHR' : 0.00025,
        'IDR' : 0.00008333333333,
        'THB' : 0.033333,
        'USD' : 1,
        'EUR' : 1.2,
    };
    
    var cash = row["Cash Cost"];
    if (isNaN(cash)) cash = 0.0;
    return exchange_rates[row["Currency"]] * cash;
}

function transformRows( rows ) {

    h = rows[1];
    
    if (!h) return null;
    
    header = [];
    for (var c in h) {
        if (h.hasOwnProperty(c)) {
            header[c-1] = h[c]
        }
    }
    
    var normalized_rows = [];
    
    for (var row in rows) {
        if (rows.hasOwnProperty(row)  && row != 1) {
        
            skip_row = false;
            
            for (var col in rows[row]) {
                if (rows[row].hasOwnProperty(col)) {
                    if (typeof(rows[row][col]) == typeof(undefined)) {
                        skip_row = true;
                        break;
                    }
                }
            }
            if (skip_row) {
                console.log( rows[row] + ' has undefineds' );
                continue;
            };
            
            normalized_rows[row] = {};
            for (var c = 0; c < header.length; c++) {
                rows[row][c+1] && (normalized_rows[row][header[c]] = rows[row][c+1]);
                if (header[c] == 'Date') {
                    normalized_rows[row][header[c]] = new Date(rows[row][c+1]);
                }
            }
        }
    }
    
    return normalized_rows.filter(function(d) { return d != undefined });
}

function buildChartData(filterFcn) {
    "use strict";

    var normalized_rows = _.filter($.GLOBALS.normalized_rows, filterFcn);

    var nested = d3.nest().key(function(d) { return d.Date; })
             .rollup(function(leaves) {
                     var y = Array.apply(null, new Array($.GLOBALS.categories.length)).map(Number.prototype.valueOf, 0);
                     var details = Array.apply(null, new Array($.GLOBALS.categories.length)).map(String.prototype.valueOf, "");
                     _.each(leaves, function(d) { y[$.GLOBALS.category_map[d.Category]] += cost(d);
                     details[$.GLOBALS.category_map[d.Category]] += "<li>" + d.Item + " &mdash; $" + cost(d).toFixed(2) + "</li>"});
                    return { "y": y, 'details': details };
              })
             .entries(normalized_rows);

    var data = {};
    data.date_map = {};
    _.each(nested, function(d) { d.y = d.values.y; d.details = d.values.details; data.date_map[d.key] = d; } );
    data.legend_labels = $.GLOBALS.categories;
    data.details = $.GLOBALS.categories;
    data.title = "Travel Expenses";
    data.raw = normalized_rows;
    
    return data;
}

function normalizeSheetRows( rows ) {
    "use strict";

    $.GLOBALS.normalized_rows = transformRows(rows);

    $.GLOBALS.categories = _.uniq($.GLOBALS.normalized_rows.map(function(d) { if (d) return d.Category; }));

    $.GLOBALS.countries = _.uniq($.GLOBALS.normalized_rows.map(function(d) { if (d) return d.Country; }));
    
    $.GLOBALS.category_map = {};
    for (var i = 0; i < $.GLOBALS.categories.length; i++) {
        $.GLOBALS.category_map[$.GLOBALS.categories[i]] = i;
    };
    
    $.GLOBALS.current_country = $.GLOBALS.countries[0];
    
    if ($.GLOBALS.countries.length > 1) {
        _.each($.GLOBALS.countries, function(d) {
        var option = '<option value="' + d.toLowerCase() + '">' + d + '</option>';
        $( '#country' ).append(option); });
        
        var selectMenu = $( '#country' ).selectmenu( { width: "200" } );
        
        selectMenu.selectmenu( 'widget' ).addClass('header-controls');
        
         selectMenu.selectmenu( { 'change': function () {
            var str = "";
            $( "select option:selected" ).each(function() {
                str = $( this ).text();
            });
        
            console.log(str);
        
            $.GLOBALS.current_country = str;
        
            var chart_data = buildChartData(function(d) { return d.Country == $.GLOBALS.current_country; } );
    
            renderChart( chart_data );
        } } );

    } else {
        $( '#country' ).css('display', 'none');
    }
    
    _.each($.GLOBALS.normalized_rows, function(d) {
        d.y = cost(d);
        d.x = d.Date;
        d.category_idx = $.GLOBALS.category_map[d.Category];
        d.detail = d.Item + " â€” $" + cost(d).toFixed(2);
    });
    
    var data = buildChartData(function(d) { return d.Country == $.GLOBALS.current_country; } );
    
    return data;
}

function renderExpenses( data ) {
    var chart_data = normalizeSheetRows( data.rows );
    
    renderChart( chart_data );
}

function renderChart( chart_data ) {
    "use strict";
    
    $('#country-name').text($.GLOBALS.current_country);
    
    var config = {
        width : 600,
        height: 300,
        tables_max_rows: 500,

        chart_color_range_start : "#0849b3",
        chart_colors : ["#c6dbef", "#9ecae1", "#6baed6"],
        xaxis_label_angle : -50,
        axis_label_font_size : 12,
        axis_label_date_length : 7,
        axis_label_date_format : d3.time.format("%d %b"),
        min_tick_width: 30,
    };

    $( '#chart' ).empty();

    var chart_info = renderDailyAreaChart(chart_data, 'chart', config);

    $( '#show-top' ).click(function (d) {
        chart_info.showTop(true);
    });
}

$( document ).ready(function () {
    "use strict";

    console.log('Ready');
    
    $( "#show-top" ).button();
    
    var expenses = $.ajax({
        url: '/data',
        dataType: 'json'
    });

    $.when(expenses).then(renderExpenses,
                          function(xhr, status, errorThrown) {
        console.log("loading " + " failed\n" + errorThrown + '\n' + status + '\n' + xhr.statusText);
    });
} );
</script>

</head>
<body>

<div class="header">
    <h1>Travel expenses for <span id="country-name"></span></h1>
    <button id="show-top" class="header-controls">Show Top Expenses</button>
    
<select id="country" class="header-controls">
</select>

<br clear="both"/>
<div class="instructions">Click on bars for details.</div>
</div>



<br clear="both"/>

<div id="chart" class="chart"></div>

<div class="footer"></div>
<svg width="0" height="0">
    <filter id="blur" x="0" y="0">
      <feGaussianBlur in="SourceGraphic" stdDeviation="5" />
    </filter>
</svg>
</body>
</html>
